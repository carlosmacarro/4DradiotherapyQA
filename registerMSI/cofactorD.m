% Computes the cofactor matrix.

% Code by Iman Aganj.

function C = cofactorD(A, oneRow)

s = size(A);
D = s(end);
if ~exist('oneRow', 'var')
    oneRow = false;
end
if oneRow
    C = zeros([s(1:D) 1 D], 'like', A);
else
    C = zeros([s(1:D) D D], 'like', A);
end

if D==2
    C(:,:,1,1) = A(:,:,2,2);
    C(:,:,1,2) = -A(:,:,2,1);
    if ~oneRow
        C(:,:,2,1) = -A(:,:,1,2);
        C(:,:,2,2) = A(:,:,1,1);
    end
else
    C(:,:,:,1,1) = A(:,:,:,2,2).*A(:,:,:,3,3) - A(:,:,:,2,3).*A(:,:,:,3,2);
    C(:,:,:,1,2) = A(:,:,:,2,3).*A(:,:,:,3,1) - A(:,:,:,2,1).*A(:,:,:,3,3);
    C(:,:,:,1,3) = A(:,:,:,2,1).*A(:,:,:,3,2) - A(:,:,:,2,2).*A(:,:,:,3,1);
    if ~oneRow
        C(:,:,:,2,1) = A(:,:,:,1,3).*A(:,:,:,3,2) - A(:,:,:,1,2).*A(:,:,:,3,3);
        C(:,:,:,2,2) = A(:,:,:,1,1).*A(:,:,:,3,3) - A(:,:,:,1,3).*A(:,:,:,3,1);
        C(:,:,:,2,3) = A(:,:,:,1,2).*A(:,:,:,3,1) - A(:,:,:,1,1).*A(:,:,:,3,2);
        C(:,:,:,3,1) = A(:,:,:,1,2).*A(:,:,:,2,3) - A(:,:,:,1,3).*A(:,:,:,2,2);
        C(:,:,:,3,2) = A(:,:,:,1,3).*A(:,:,:,2,1) - A(:,:,:,1,1).*A(:,:,:,2,3);
        C(:,:,:,3,3) = A(:,:,:,1,1).*A(:,:,:,2,2) - A(:,:,:,1,2).*A(:,:,:,2,1);
    end
end
